<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>ISO Lead Analyse</title>

  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #f4f6f9;
      padding: 40px;
    }

    .container {
      max-width: 1100px;
      margin: auto;
      background: white;
      padding: 40px;
      border-radius: 14px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.08);
    }

    h1 {
      margin-bottom: 30px;
    }

    textarea {
      width: 100%;
      padding: 15px;
      border-radius: 10px;
      border: 1px solid #ddd;
      font-size: 14px;
      resize: vertical;
    }

    button {
      padding: 12px 24px;
      margin-top: 20px;
      background: #2563eb;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
    }

    button:hover {
      background: #1e40af;
    }

    .result {
      margin-top: 40px;
      padding: 25px;
      background: #f9fafb;
      border-radius: 12px;
    }

    .score {
      font-size: 48px;
      font-weight: bold;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 30px;
    }

    th,
    td {
      padding: 12px;
      border-bottom: 1px solid #eee;
      text-align: left;
      font-size: 14px;
    }

    th {
      background: #f3f4f6;
    }

    .green {
      color: #16a34a;
      font-weight: 700;
    }

    .orange {
      color: #f59e0b;
      font-weight: 700;
    }

    .red {
      color: #dc2626;
      font-weight: 700;
    }
  </style>
</head>

<body>

  <div class="container">

    <h1>ISO Lead Analyse</h1>

    <textarea id="inputText" rows="5" placeholder="Beschrijf hier de organisatie of lead..."></textarea>
    <br>
    <button onclick="analyseer()">Analyseer</button>

    <div id="resultBox" class="result"></div>

    <h2>Lead Historie</h2>

    <table>
      <thead>
        <tr>
          <th>Reference</th>
          <th>Datum</th>
          <th>ISO</th>
          <th>Score</th>
          <th>Kans</th>
          <th>Confidence</th>
        </tr>
      </thead>
      <tbody id="leadTableBody">
      </tbody>
    </table>

  </div>

  <script>

    function scoreClass(score) {
      if (score >= 8) return "green";
      if (score >= 5) return "orange";
      return "red";
    }

    async function analyseer() {

      const text = document.getElementById("inputText").value;

      if (!text.trim()) {
        alert("Voer eerst een beschrijving in.");
        return;
      }

      try {
        const response = await fetch("/iso", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ text: text })
        });

        const result = await response.json();

        const cls = scoreClass(result.lead_score);

        document.getElementById("resultBox").innerHTML = `
            <div class="score ${cls}">${result.lead_score}/10</div>
            <p><strong>Reference:</strong> ${result.reference_id}</p>
            <p><strong>ISO:</strong> ${result.iso_norm}</p>
            <p><strong>Kans:</strong> ${result.commerciele_kans}</p>
            <p><strong>Confidence:</strong> ${result.confidence}%</p>
            <p>${result.samenvatting}</p>
        `;

        loadLeads();

      } catch (error) {
        alert("Fout bij analyse.");
        console.error(error);
      }
    }

    async function loadLeads() {

      try {
        const response = await fetch("/leads");
        const leads = await response.json();

        const tbody = document.getElementById("leadTableBody");
        tbody.innerHTML = "";

        leads.forEach(lead => {

          const cls = scoreClass(lead.lead_score);

          tbody.innerHTML += `
                <tr>
                    <td>${lead.reference_id || "-"}</td>
                    <td>${lead.created_at}</td>
                    <td>${lead.iso_norm}</td>
                    <td class="${cls}">${lead.lead_score}</td>
                    <td>${lead.commerciele_kans}</td>
                    <td>${lead.confidence}%</td>
                </tr>
            `;
        });

      } catch (error) {
        console.error("Fout bij laden leads", error);
      }
    }

    window.onload = loadLeads;

  </script>

</body>

</html>